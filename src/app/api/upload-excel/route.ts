import { NextRequest, NextResponse } from 'next/server'
import * as XLSX from 'xlsx'
import { prisma } from '@/lib/prisma'

// T√ºrk√ße karakterleri normalize eden yardƒ±mcƒ±
function normalizeKey(key: string) {
  return key
    .toLowerCase()
    .replace(/[ƒ±ƒ∞]/g, 'i')
    .replace(/[≈ü≈û]/g, 's')
    .replace(/[ƒüƒû]/g, 'g')
    .replace(/[√º√ú]/g, 'u')
    .replace(/[√∂√ñ]/g, 'o')
    .replace(/[√ß√á]/g, 'c')
    .replace(/[^a-z0-9]+/g, '') // bo≈üluk, noktalama vs kaldƒ±r
}

function parseTrNumber(val: any): number | undefined {
  if (val === undefined || val === null || val === '') return undefined
  if (typeof val === 'number') {
    return isNaN(val) ? undefined : val
  }
  if (typeof val !== 'string') return undefined
  
  try {
    // T√ºrk√ße sayƒ± formatƒ±nƒ± temizle: "1.234,56" -> "1234.56"
    const cleaned = val.trim()
      .replace(/\s/g, '') // Bo≈üluklarƒ± kaldƒ±r
      .replace(/\./g, '') // Binlik ayƒ±rƒ±cƒ± noktalarƒ± kaldƒ±r
      .replace(/,/g, '.') // Ondalƒ±k virg√ºl√º noktaya √ßevir
    
    if (cleaned === '') return undefined
    
    const num = parseFloat(cleaned)
    return isNaN(num) ? undefined : num
  } catch (error) {
    console.warn(`[parseTrNumber] Sayƒ± d√∂n√º≈üt√ºrme hatasƒ±: "${val}"`, error)
    return undefined
  }
}

// Yeni: Kapsamlƒ± veri tipi doƒürulama fonksiyonu
function validateAndConvertTypes(data: any): { isValid: boolean; errors: string[]; convertedData?: any } {
  const errors: string[] = []
  const convertedData: any = {}
  
  try {
    // durumTanitici - zorunlu string field
    if (!data.durumTanitici || String(data.durumTanitici).trim() === '') {
      errors.push('durumTanitici alanƒ± zorunludur ve bo≈ü olamaz')
    } else {
      convertedData.durumTanitici = String(data.durumTanitici).trim()
    }
    
    // String alanlarƒ± g√ºvenli d√∂n√º≈üt√ºr
    const stringFields = [
      'ilgiliTCKN', 'avukatAtamaTarihi', 'durum', 'muhatapTanimi', 'durumTanimi',
      'sozlesmeHesabi', 'tcKimlikNo', 'vergiNo', 'icraDosyaNumarasi', 'icraDairesiTanimi',
      'adresBilgileri', 'il', 'ilce', 'telefon', 'telefon2', 'telefon3', 'telefonAboneGrubu', 'itirazDurumu',
      'borcluTipiTanimi', 'hitamTarihi', 'takipTarihi', 'nedenTanimi', 'durumTuru',
      'durumTuruTanimi', 'tesisatDurumu', 'odemeDurumu', 'neden', 'muhatapTanimiEk',
      'uyapDurumu', 'telefonTesisat', 'tesisatDurumuTanimi', 'ad', 'soyad'
    ]
    
    stringFields.forEach(field => {
      if (data[field] !== undefined && data[field] !== null) {
        const stringValue = String(data[field]).trim()
        convertedData[field] = stringValue !== '' ? stringValue : undefined
      } else {
        convertedData[field] = undefined
      }
    })
    
    // Sayƒ±sal alanlarƒ± d√∂n√º≈üt√ºr
    const numericFields = [
      'asilAlacak', 'takipCikisMiktari', 'takipOncesiTahsilat', 'takipSonrasiTahsilat',
      'toplamAcikTutar', 'guncelBorc', 'vekaletUcreti'
    ]
    
    numericFields.forEach(field => {
      if (data[field] !== undefined && data[field] !== null) {
        const numValue = parseTrNumber(data[field])
        if (numValue !== undefined && numValue < 0) {
          errors.push(`${field} alanƒ± negatif olamaz`)
        }
        convertedData[field] = numValue
      } else {
        convertedData[field] = undefined
      }
    })
    
    return {
      isValid: errors.length === 0,
      errors,
      convertedData: errors.length === 0 ? convertedData : undefined
    }
  } catch (error) {
    errors.push(`Veri doƒürulama hatasƒ±: ${error instanceof Error ? error.message : 'Bilinmeyen hata'}`)
    return { isValid: false, errors }
  }
}

// Yeni: Zorunlu alanlarƒ± kontrol et
function validateRequiredFields(data: any): string[] {
  const errors: string[] = []
  
  if (!data.durumTanitici || String(data.durumTanitici).trim() === '') {
    errors.push('Durum Tanƒ±tƒ±cƒ± alanƒ± zorunludur')
  }
  
  return errors
}

// Yeni: Hata kategorileri
enum ErrorType {
  TYPE_MISMATCH = 'TYPE_MISMATCH',
  REQUIRED_FIELD = 'REQUIRED_FIELD',
  DATABASE_ERROR = 'DATABASE_ERROR',
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  PROCESSING_ERROR = 'PROCESSING_ERROR'
}

interface ProcessingError {
  rowIndex: number
  field?: string
  value?: any
  errorType: ErrorType
  message: string
  suggestion?: string
}

interface ProcessingWarning {
  rowIndex: number
  field?: string
  message: string
}

// Yeni: Geli≈ümi≈ü hata loglama
function logProcessingError(
  rowIndex: number, 
  error: any, 
  data: any, 
  context: string = ''
): ProcessingError {
  const errorMessage = error instanceof Error ? error.message : String(error)
  
  let errorType = ErrorType.PROCESSING_ERROR
  let suggestion = ''
  
  // Hata tipini belirle
  if (errorMessage.includes('Invalid value provided') || errorMessage.includes('Expected')) {
    errorType = ErrorType.TYPE_MISMATCH
    suggestion = 'Veri tipini kontrol edin ve doƒüru formatta olduƒüundan emin olun'
  } else if (errorMessage.includes('required') || errorMessage.includes('zorunlu')) {
    errorType = ErrorType.REQUIRED_FIELD
    suggestion = 'Zorunlu alanlarƒ±n dolu olduƒüundan emin olun'
  } else if (errorMessage.includes('Unique constraint') || errorMessage.includes('UNIQUE')) {
    errorType = ErrorType.DATABASE_ERROR
    suggestion = 'Bu Durum Tanƒ±tƒ±cƒ± zaten mevcut, g√ºncelleme modunu kullanƒ±n'
  } else if (errorMessage.includes('validation') || errorMessage.includes('doƒürulama')) {
    errorType = ErrorType.VALIDATION_ERROR
    suggestion = 'Veri formatƒ±nƒ± kontrol edin'
  }
  
  const processingError: ProcessingError = {
    rowIndex,
    errorType,
    message: errorMessage,
    suggestion
  }
  
  // Detaylƒ± log
  console.error(`[upload-excel][${context}] Satƒ±r ${rowIndex + 2} hatasƒ±:`, {
    error: errorMessage,
    errorType,
    data: {
      durumTanitici: data?.durumTanitici || 'Tanƒ±msƒ±z',
      muhatapTanimi: data?.muhatapTanimi || 'Tanƒ±msƒ±z'
    },
    suggestion
  })
  
  return processingError
}

// Yeni: Hatalarƒ± kategorize et
function categorizeErrors(errors: ProcessingError[]): Record<ErrorType, ProcessingError[]> {
  const categorized: Record<ErrorType, ProcessingError[]> = {
    [ErrorType.TYPE_MISMATCH]: [],
    [ErrorType.REQUIRED_FIELD]: [],
    [ErrorType.DATABASE_ERROR]: [],
    [ErrorType.VALIDATION_ERROR]: [],
    [ErrorType.PROCESSING_ERROR]: []
  }
  
  errors.forEach(error => {
    categorized[error.errorType].push(error)
  })
  
  return categorized
}

// Yeni: Hata raporu olu≈ütur
function generateErrorReport(errors: ProcessingError[]): string {
  if (errors.length === 0) return ''
  
  const categorized = categorizeErrors(errors)
  const report: string[] = []
  
  Object.entries(categorized).forEach(([type, typeErrors]) => {
    if (typeErrors.length > 0) {
      let categoryName = ''
      switch (type as ErrorType) {
        case ErrorType.TYPE_MISMATCH:
          categoryName = 'Veri Tipi Hatalarƒ±'
          break
        case ErrorType.REQUIRED_FIELD:
          categoryName = 'Zorunlu Alan Hatalarƒ±'
          break
        case ErrorType.DATABASE_ERROR:
          categoryName = 'Veritabanƒ± Hatalarƒ±'
          break
        case ErrorType.VALIDATION_ERROR:
          categoryName = 'Doƒürulama Hatalarƒ±'
          break
        case ErrorType.PROCESSING_ERROR:
          categoryName = 'ƒ∞≈ülem Hatalarƒ±'
          break
      }
      
      report.push(`${categoryName}: ${typeErrors.length} hata`)
    }
  })
  
  return report.join(', ')
}

// Yeni: Kullanƒ±cƒ± i√ßin sonraki adƒ±mlar √∂ner
function generateNextSteps(summary: any, errors: ProcessingError[], warnings: ProcessingWarning[]): string[] {
  const steps: string[] = []
  
  if (summary.successRate === 100) {
    steps.push('üéâ T√ºm veriler ba≈üarƒ±yla i≈ülendi!')
    if (warnings.length > 0) {
      steps.push('üìã Veri kalitesini artƒ±rmak i√ßin uyarƒ±larƒ± g√∂zden ge√ßirebilirsiniz')
    }
    steps.push('üìä Bor√ßlu listesini g√∂r√ºnt√ºlemek i√ßin "Bor√ßlular" sayfasƒ±na gidin')
    return steps
  }
  
  if (summary.successRate === 0) {
    steps.push('üîç Excel dosyanƒ±zƒ±n formatƒ±nƒ± kontrol edin')
    steps.push('üìù √ñrnek Excel ≈üablonunu indirip kullanƒ±n')
    steps.push('‚úÖ Zorunlu alanlarƒ±n dolu olduƒüundan emin olun')
    
    const typeErrors = errors.filter(e => e.errorType === ErrorType.TYPE_MISMATCH)
    if (typeErrors.length > 0) {
      steps.push('üî¢ Sayƒ±sal alanlarƒ±n T√ºrk√ße format (1.234,56) olduƒüunu kontrol edin')
    }
    
    const requiredErrors = errors.filter(e => e.errorType === ErrorType.REQUIRED_FIELD)
    if (requiredErrors.length > 0) {
      steps.push('‚ö†Ô∏è "Durum Tanƒ±tƒ±cƒ±" s√ºtununun her satƒ±rda dolu olduƒüundan emin olun')
    }
    
    return steps
  }
  
  // Kƒ±smi ba≈üarƒ± durumu
  steps.push(`‚úÖ ${summary.processedRows} kayƒ±t ba≈üarƒ±yla i≈ülendi`)
  steps.push(`‚ùå ${summary.failedRows} kayƒ±t i≈ülenemedi`)
  
  if (summary.failedRows > 0) {
    steps.push('üìã Hatalƒ± satƒ±rlarƒ± Excel\'de d√ºzeltin ve tekrar y√ºkleyin')
    
    const commonErrors = errors.reduce((acc, error) => {
      acc[error.errorType] = (acc[error.errorType] || 0) + 1
      return acc
    }, {} as Record<string, number>)
    
    const mostCommonError = Object.entries(commonErrors)
      .sort(([,a], [,b]) => b - a)[0]
    
    if (mostCommonError) {
      const [errorType, count] = mostCommonError
      switch (errorType) {
        case ErrorType.TYPE_MISMATCH:
          steps.push(`üî¢ En √ßok veri tipi hatasƒ± var (${count} adet) - sayƒ± formatlarƒ±nƒ± kontrol edin`)
          break
        case ErrorType.REQUIRED_FIELD:
          steps.push(`üìù En √ßok zorunlu alan hatasƒ± var (${count} adet) - bo≈ü h√ºcreleri doldurun`)
          break
        case ErrorType.DATABASE_ERROR:
          steps.push(`üíæ Veritabanƒ± hatalarƒ± var (${count} adet) - duplicate kayƒ±tlarƒ± kontrol edin`)
          break
      }
    }
  }
  
  if (warnings.length > 0) {
    steps.push(`‚ö†Ô∏è ${warnings.length} uyarƒ± var - veri kalitesini artƒ±rabilirsiniz`)
    
    if (summary.dataQuality.emptyMuhatapCount > 0) {
      steps.push('üë§ Muhatap tanƒ±mƒ± bo≈ü olan kayƒ±tlarƒ± tamamlayƒ±n')
    }
    if (summary.dataQuality.invalidTCKNCount > 0) {
      steps.push('üÜî Ge√ßersiz TC kimlik numaralarƒ±nƒ± d√ºzeltin')
    }
    if (summary.dataQuality.invalidPhoneCount > 0) {
      steps.push('üìû Ge√ßersiz telefon numaralarƒ±nƒ± d√ºzeltin')
    }
  }
  
  steps.push('üìä ƒ∞≈ülenen kayƒ±tlarƒ± g√∂r√ºnt√ºlemek i√ßin "Bor√ßlular" sayfasƒ±na gidin')
  
  return steps
}

// Yeni: Metin temizleme ve doƒürulama
function sanitizeText(value: any): string | undefined {
  if (value === undefined || value === null) return undefined
  
  const text = String(value).trim()
  if (text === '') return undefined
  
  // Zararlƒ± karakterleri temizle
  const cleaned = text
    .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '') // Kontrol karakterleri
    .replace(/\s+/g, ' ') // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa √ßevir
    .trim()
  
  return cleaned !== '' ? cleaned : undefined
}

// Yeni: Telefon numarasƒ± doƒürulama ve temizleme
function sanitizePhoneNumber(value: any): string | undefined {
  if (value === undefined || value === null) return undefined
  
  const phone = String(value).trim()
  if (phone === '') return undefined
  
  // Sadece rakamlarƒ± al
  const digitsOnly = phone.replace(/\D/g, '')
  
  // T√ºrk telefon numarasƒ± formatlarƒ±
  if (digitsOnly.length === 10 && digitsOnly.startsWith('5')) {
    return digitsOnly // 5xxxxxxxxx
  } else if (digitsOnly.length === 11 && digitsOnly.startsWith('05')) {
    return digitsOnly.substring(1) // 05xxxxxxxxx -> 5xxxxxxxxx
  } else if (digitsOnly.length === 13 && digitsOnly.startsWith('905')) {
    return digitsOnly.substring(2) // 905xxxxxxxxx -> 5xxxxxxxxx
  } else if (digitsOnly.length >= 7) {
    return digitsOnly // Diƒüer formatlar i√ßin ham veriyi d√∂nd√ºr
  }
  
  return undefined
}

// Yeni: TC Kimlik No doƒürulama
function validateTCKN(value: any): string | undefined {
  if (value === undefined || value === null) return undefined
  
  const tckn = String(value).trim().replace(/\D/g, '')
  if (tckn.length !== 11) return undefined
  
  // Basit TCKN doƒürulama
  if (tckn === '00000000000' || tckn[0] === '0') return undefined
  
  return tckn
}

// Yeni: Tarih doƒürulama ve temizleme
function sanitizeDate(value: any): string | undefined {
  if (value === undefined || value === null) return undefined
  
  const dateStr = String(value).trim()
  if (dateStr === '') return undefined
  
  // Excel tarih formatlarƒ± i√ßin
  if (/^\d{5}$/.test(dateStr)) {
    // Excel serial date (√∂rn: 45821)
    try {
      const excelDate = new Date((parseInt(dateStr) - 25569) * 86400 * 1000)
      return excelDate.toISOString().split('T')[0] // YYYY-MM-DD formatƒ±
    } catch {
      return dateStr // D√∂n√º≈üt√ºr√ºlemezse orijinal deƒüeri d√∂nd√ºr
    }
  }
  
  // Diƒüer tarih formatlarƒ± i√ßin orijinal deƒüeri d√∂nd√ºr
  return dateStr
}

// Yeni: Geli≈ümi≈ü alan doƒürulama
function validateFieldIntegrity(fieldName: string, value: any, rowData: any): ProcessingWarning[] {
  const warnings: ProcessingWarning[] = []
  
  switch (fieldName) {
    case 'tcKimlikNo':
    case 'ilgiliTCKN':
      if (value && !validateTCKN(value)) {
        warnings.push({
          rowIndex: -1, // Caller tarafƒ±ndan set edilecek
          field: fieldName,
          message: `${fieldName} ge√ßersiz format (11 haneli olmalƒ±)`
        })
      }
      break
      
    case 'telefon':
    case 'telefon2':
    case 'telefon3':
      if (value && !sanitizePhoneNumber(value)) {
        warnings.push({
          rowIndex: -1,
          field: fieldName,
          message: 'Telefon numarasƒ± ge√ßersiz format'
        })
      }
      break
      
    case 'guncelBorc':
    case 'asilAlacak':
      if (value !== undefined && (typeof value !== 'number' || value < 0)) {
        warnings.push({
          rowIndex: -1,
          field: fieldName,
          message: `${fieldName} negatif olamaz`
        })
      }
      break
      
    case 'muhatapTanimi':
      if (!value || String(value).trim() === '') {
        warnings.push({
          rowIndex: -1,
          field: fieldName,
          message: 'Muhatap tanƒ±mƒ± bo≈ü, veri kalitesi d√º≈ü√ºk olabilir'
        })
      }
      break
  }
  
  return warnings
}

// Yeni: Kapsamlƒ± veri temizleme
function sanitizeRowData(rawData: any): any {
  const sanitized: any = {}
  
  // String alanlarƒ± temizle
  const stringFields = [
    'durumTanitici', 'ilgiliTCKN', 'durum', 'muhatapTanimi', 'durumTanimi',
    'sozlesmeHesabi', 'vergiNo', 'icraDosyaNumarasi', 'icraDairesiTanimi',
    'adresBilgileri', 'il', 'ilce', 'telefonAboneGrubu', 'itirazDurumu',
    'borcluTipiTanimi', 'nedenTanimi', 'durumTuru', 'durumTuruTanimi',
    'tesisatDurumu', 'odemeDurumu', 'neden', 'muhatapTanimiEk',
    'uyapDurumu', 'telefonTesisat', 'tesisatDurumuTanimi', 'ad', 'soyad'
  ]
  
  stringFields.forEach(field => {
    sanitized[field] = sanitizeText(rawData[field])
  })
  
  // √ñzel alanlarƒ± temizle
  sanitized.telefon = sanitizePhoneNumber(rawData.telefon)
  sanitized.telefon2 = sanitizePhoneNumber(rawData.telefon2)
  sanitized.telefon3 = sanitizePhoneNumber(rawData.telefon3)
  sanitized.tcKimlikNo = validateTCKN(rawData.tcKimlikNo)
  sanitized.ilgiliTCKN = validateTCKN(rawData.ilgiliTCKN)
  
  // Tarih alanlarƒ±
  sanitized.avukatAtamaTarihi = sanitizeDate(rawData.avukatAtamaTarihi)
  sanitized.takipTarihi = sanitizeDate(rawData.takipTarihi)
  sanitized.hitamTarihi = sanitizeDate(rawData.hitamTarihi)
  
  // Sayƒ±sal alanlar (zaten parseTrNumber ile i≈üleniyor)
  const numericFields = [
    'asilAlacak', 'takipCikisMiktari', 'takipOncesiTahsilat', 'takipSonrasiTahsilat',
    'toplamAcikTutar', 'guncelBorc', 'vekaletUcreti'
  ]
  
  numericFields.forEach(field => {
    sanitized[field] = rawData[field] // parseTrNumber zaten uygulanmƒ±≈ü
  })
  
  return sanitized
}

function getValue(row: Record<string, any>, candidates: string[]): any {
  // satƒ±rƒ±n anahtarlarƒ±nƒ± normalize et
  const normRow: Record<string, any> = {}
  const keys: string[] = []
  for (const [k, v] of Object.entries(row)) {
    const norm = normalizeKey(k)
    normRow[norm] = v
    keys.push(norm)
  }
  for (const c of candidates) {
    const key = normalizeKey(c)
    // 1) Tam e≈üle≈üme
    if (key in normRow) {
      const val = normRow[key]
      return typeof val === 'string' ? val.trim() : val
    }
    // 2) √áoƒüaltƒ±lmƒ±≈ü ba≈ülƒ±klar (√∂rn: muhataptanimi1, muhataptanimi2, telefon1 ...)
    const foundKey = keys.find(k => k === key || k.startsWith(key))
    if (foundKey) {
      const val = normRow[foundKey]
      return typeof val === 'string' ? val.trim() : val
    }
  }
  return undefined
}

export async function POST(request: NextRequest) {
  let transaction: any = null
  
  try {
    const formData = await request.formData()
    const file = formData.get('file') as File
    const mode = formData.get('mode') as string || 'replace' // 'replace' veya 'update'

    if (!file) {
      return NextResponse.json(
        { error: 'Dosya bulunamadƒ±' },
        { status: 400 }
      )
    }

    // Excel dosyasƒ±nƒ± oku
    const buffer = await file.arrayBuffer()
    const workbook = XLSX.read(buffer, { type: 'buffer' })
    const sheetName = workbook.SheetNames[0]
    const worksheet = workbook.Sheets[sheetName]
    const data = XLSX.utils.sheet_to_json(worksheet)
    
    // B√ºy√ºk dosyalar i√ßin transaction ba≈ülat
    const shouldUseTransaction = data.length > 100 || mode === 'replace'
    if (shouldUseTransaction) {
      console.log(`[upload-excel] Transaction ba≈ülatƒ±lƒ±yor (${data.length} satƒ±r)`)
    }

    let successCount = 0
    let errorCount = 0
    let updatedCount = 0
    let createdCount = 0
    const errors: string[] = []
    const processingErrors: ProcessingError[] = []
    const warnings: ProcessingWarning[] = []
    
    // Kritik hatalar i√ßin rollback flag
    let hasCriticalErrors = false
    const processedRecords: string[] = [] // Ba≈üarƒ±lƒ± i≈ülemleri takip et

    // Progress tracking i√ßin
    const totalRows = data.length
    const progressInterval = Math.max(1, Math.floor(totalRows / 20)) // %5'lik aralƒ±klarla progress
    
    console.log(`[upload-excel] ƒ∞≈ülem ba≈ülatƒ±lƒ±yor: ${totalRows} satƒ±r`)

    for (const [index, row] of data.entries()) {
      // Progress reporting
      if (index % progressInterval === 0 || index === totalRows - 1) {
        const progressPercent = Math.round((index / totalRows) * 100)
        console.log(`[upload-excel] ƒ∞lerleme: %${progressPercent} (${index + 1}/${totalRows})`)
      }
      try {
        const r = row as Record<string, any>

        // Ger√ßek Excel s√ºtun ba≈ülƒ±klarƒ±na g√∂re alanlarƒ± yakala
        const ilgiliTCKN = getValue(r, [
          'ƒ∞lgili TCKN', 'ilgili TCKN', 'TC Kimlik No', 'T.C. Kimlik No', 'TCKN', 'tc no', 'tc kimlik no', 'ilgili_tckn', 'tcKimlikNo'
        ])
        const durumTaniciRaw = getValue(r, [
          'Durum tanƒ±tƒ±cƒ±sƒ±', 'Durum Tanƒ±tƒ±cƒ±sƒ±', 'Durum Tanƒ±tƒ±cƒ±', 'Durum Tanitici', 'Durum Taniticisi', 'durum_tanitici', 'durumTanitici'
        ])
        
        // durumTanitici'yi her zaman string'e √ßevir (Prisma schema String bekliyor)
        const durumTanitici = durumTaniciRaw !== undefined && durumTaniciRaw !== null ? String(durumTaniciRaw).trim() : undefined

        // Excel dosyasƒ±ndaki ger√ßek "Muhatap tanƒ±mƒ±" s√ºtununu yakala
        // √ñnce direkt s√ºtun adƒ±yla dene
        let muhatapTanimi: any = r['Muhatap tanƒ±mƒ±'] || r['Muhatap Tanƒ±mƒ±'] || r['muhatap tanƒ±mƒ±']
        
        // Eƒüer bulunamazsa getValue fonksiyonuyla dene
        if (!muhatapTanimi) {
          muhatapTanimi = getValue(r, [
            'Muhatap tanƒ±mƒ±',
            'Muhatap Tanƒ±mƒ±', 
            'muhatap tanƒ±mƒ±',
            'MUHATAP TANIMI',
            'Muhatap Tanimi', 
            'muhataptanimi', 
            'muhataptanƒ±mƒ±', 
            'muhatap_tanimi', 
            'muhatap_tanƒ±mƒ±',
            'muhatap'
          ])
        }
        
        // Debug: ƒ∞lk 3 satƒ±rda t√ºm s√ºtun ba≈ülƒ±klarƒ±nƒ± ve muhatap tanƒ±mƒ±nƒ± logla
        if (index < 3) {
          console.log(`=== SATIR ${index + 2} ===`)
          console.log('Muhatap tanƒ±mƒ± s√ºtunu:', r['Muhatap tanƒ±mƒ±'])
          console.log('Muhatap Tanƒ±mƒ± s√ºtunu:', r['Muhatap Tanƒ±mƒ±'])
          console.log('Bulunan muhatapTanimi:', muhatapTanimi)
          if (index === 0) {
            console.log('T√úM S√úTUN BA≈ûLIKLARI:', Object.keys(r))
            // Muhatap i√ßeren s√ºtunlarƒ± √∂zellikle g√∂ster
            Object.keys(r).forEach(key => {
              if (key.toLowerCase().includes('muhatap')) {
                console.log(`MUHATAP S√úTUNU BULUNDU: "${key}" = "${r[key]}"`)
              }
            })
          }
          console.log('==================')
        }
        
        // Eƒüer hala muhatapTanimi bulunamadƒ±ysa, t√ºm s√ºtunlarƒ± kontrol et
        if (!muhatapTanimi) {
          console.log(`Satƒ±r ${index + 2}: Muhatap tanƒ±mƒ± bulunamadƒ±, t√ºm s√ºtunlarƒ± tarƒ±yorum...`)
          
          // T√ºm s√ºtunlarƒ± kontrol et
          for (const [key, value] of Object.entries(r)) {
            console.log(`Kontrol ediliyor: "${key}" = "${value}"`)
            if (value && String(value).trim()) {
              const keyLower = key.toLowerCase()
              // Muhatap i√ßeren s√ºtunlarƒ± √∂ncelikle kontrol et
              if (keyLower.includes('muhatap')) {
                muhatapTanimi = String(value).trim()
                console.log(`MUHATAP BULUNDU: "${key}" = "${muhatapTanimi}"`)
                break
              }
            }
          }
        }
        
        // Adres bilgilerini kontrol eden geli≈ümi≈ü yardƒ±mcƒ± fonksiyon
        function isAddressLike(text: string): boolean {
          if (!text) return false
          const upperText = text.toUpperCase().trim()
          
          // Adres anahtar kelimeleri
          const addressKeywords = [
            'MAH', 'MAHALLE', 'MAHALLESI', 'SOK', 'SOKAK', 'SOKAƒûI', 'CAD', 'CADDE', 'CADDESƒ∞',
            'NO', 'NUMARA', 'APT', 'APARTMAN', 'APARTMANI', 'BLOK', 'KAT', 'DAƒ∞RE', 'DAIRE',
            'BA≈û√ñƒûRETMEN', 'ADEM', 'HAMƒ∞Dƒ∞YE', 'ƒ∞√áERENK√ñY', '√áEKMEK√ñY', 'ATA≈ûEHƒ∞R',
            'FETƒ∞H', '√úNAYDIN', 'ALTIN≈ûEHƒ∞R', 'HAYAT', '√úMRANƒ∞YE', 'FEVZƒ∞', '√áAKMAK', 'ACELE', 'PENDƒ∞K',
            '√áENGELK√ñY', '√ñZLEM', '√úSK√úDAR', 'Eƒûƒ∞Tƒ∞M', 'M√úCEVHER', 'KADIK√ñY', 'ƒ∞STƒ∞KLAL', 'Cƒ∞HAN',
            'ƒ∞STANBUL', 'ANKARA', 'ƒ∞ZMƒ∞R', 'BURSA', 'ANTALYA', 'ADANA', 'KONYA', 'GAZƒ∞ANTEP',
            '≈ûANLIURFA', 'KOCAELƒ∞', 'MERSƒ∞N', 'Dƒ∞YARBAKIR', 'HATAY', 'MANƒ∞SA', 'KAYSERI',
            'SAMSUN', 'BALIKESƒ∞R', 'KAHRAMANMARA≈û', 'VAN', 'AYDIN', 'DENIZLI', 'MUƒûLA',
            'TEKƒ∞RDAƒû', 'TRABZON', '≈ûAHINBEY', 'ADAPAZARI', 'MALATYA', 'ERZURUM', 'ORDU',
            'MERKEZ', 'KUZEY', 'G√úNEY', 'DOƒûU', 'BATI', 'YENƒ∞', 'ESKƒ∞', 'B√úY√úK', 'K√ú√á√úK'
          ]
          
          // Adres anahtar kelimelerini kontrol et
          const hasAddressKeywords = addressKeywords.some(keyword => upperText.includes(keyword))
          
          // Sayƒ± + kelime kombinasyonlarƒ±nƒ± kontrol et (√∂rn: "NO 52", "52 √áEKMEK√ñY")
          const hasNumberPattern = /\b\d+\s+[A-Z√áƒûIƒ∞√ñ≈û√ú]+|[A-Z√áƒûIƒ∞√ñ≈û√ú]+\s+\d+\b/.test(upperText)
          
          // √áok uzun metinler genellikle adrestir (50+ karakter)
          const isTooLong = upperText.length > 50
          
          // Birden fazla "/" i√ßeren metinler genellikle adrestir
          const hasMultipleSlashes = (upperText.match(/\//g) || []).length > 1
          
          // Posta kodu benzeri pattern (5 haneli sayƒ±)
          const hasPostalCode = /\b\d{5}\b/.test(upperText)
          
          return hasAddressKeywords || hasNumberPattern || isTooLong || hasMultipleSlashes || hasPostalCode
        }

        // ƒ∞sim/≈ûirket benzeri olup olmadƒ±ƒüƒ±nƒ± kontrol eden fonksiyon
        function isNameLike(text: string): boolean {
          if (!text) return false
          const trimmed = text.trim()
          
          // √áok kƒ±sa (2 karakterden az) veya √ßok uzun (100+ karakter) deƒüilse
          if (trimmed.length < 2 || trimmed.length > 100) return false
          
          // Adres benzeri deƒüilse
          if (isAddressLike(trimmed)) return false
          
          // ≈ûirket isimleri i√ßin geni≈ületilmi≈ü pattern
          // Harf, bo≈üluk, T√ºrk√ße karakterler, sayƒ±lar, nokta, tire, ve, ampersand
          const namePattern = /^[A-Z√áƒûIƒ∞√ñ≈û√úa-z√ßƒüƒ±i√∂≈ü√º0-9\s\.\-&VE]+$/
          if (!namePattern.test(trimmed)) return false
          
          // ≈ûirket anahtar kelimeleri
          const companyKeywords = [
            'LTD', '≈ûTƒ∞', 'A.≈û', 'A≈û', 'LLC', 'INC', 'CORP', 'CO', 'COMPANY', '≈ûƒ∞RKETƒ∞',
            'Tƒ∞CARET', 'SANAYƒ∞', 'ƒ∞N≈ûAAT', 'GIDA', 'TEKSTƒ∞L', 'OTOMOTƒ∞V', 'ELEKTRONƒ∞K',
            'MARKET', 'MAƒûAZA', 'RESTORAN', 'CAFE', 'OTEL', 'HASTANE', 'KLƒ∞Nƒ∞K',
            'ECZANE', 'BERBER', 'KUAF√ñR', 'TAMƒ∞R', 'SERVƒ∞S', 'AT√ñLYE'
          ]
          
          const upperText = trimmed.toUpperCase()
          const hasCompanyKeyword = companyKeywords.some(keyword => upperText.includes(keyword))
          
          // Eƒüer ≈üirket anahtar kelimesi varsa, kesinlikle isim benzeri
          if (hasCompanyKeyword) return true
          
          // Ki≈üi ismi kontrol√º (sadece harf ve bo≈üluk)
          const personNamePattern = /^[A-Z√áƒûIƒ∞√ñ≈û√úa-z√ßƒüƒ±i√∂≈ü√º\s]+$/
          if (personNamePattern.test(trimmed)) {
            // TC kimlik numarasƒ± deƒüilse
            if (!/^\d{11}$/.test(trimmed.replace(/\s/g, ''))) {
              return true
            }
          }
          
          // Karma isim/≈üirket (harf + sayƒ± kombinasyonu)
          const mixedPattern = /^[A-Z√áƒûIƒ∞√ñ≈û√úa-z√ßƒüƒ±i√∂≈ü√º][A-Z√áƒûIƒ∞√ñ≈û√úa-z√ßƒüƒ±i√∂≈ü√º0-9\s\.\-&]*$/
          if (mixedPattern.test(trimmed)) {
            // √áok fazla sayƒ± i√ßermiyorsa (telefon numarasƒ± vs. deƒüilse)
            const digitCount = (trimmed.match(/\d/g) || []).length
            if (digitCount < trimmed.length / 2) {
              return true
            }
          }
          
          return false
        }
        
        // Muhatap tanƒ±mƒ±nƒ± temizle ve doƒürula
        if (muhatapTanimi !== undefined && muhatapTanimi !== null) {
          muhatapTanimi = String(muhatapTanimi).trim()
          
          // "Bor√ßlu" kelimesini i√ßeren tanƒ±mlarƒ± temizle
          if (muhatapTanimi.toLowerCase() === 'bor√ßlu' || muhatapTanimi.toLowerCase() === 'borclu') {
            muhatapTanimi = ''
          }
          
          // TC kimlik numarasƒ± i√ßeren tanƒ±mlarƒ± temizle (11 haneli sayƒ±)
          if (/^\d{11}$/.test(muhatapTanimi.replace(/\s/g, ''))) {
            muhatapTanimi = ''
          }
          
          // "CENGƒ∞Z KAMA / √áAKMAK-MERKEZ" gibi formatta ise, ilk kƒ±smƒ± al ve doƒürula
          if (muhatapTanimi && muhatapTanimi.includes('/')) {
            const parts = muhatapTanimi.split('/')
            if (parts.length > 0 && parts[0].trim()) {
              const firstPart = parts[0].trim()
              // ƒ∞lk kƒ±sƒ±m isim benzeri ise kullan, deƒüilse temizle
              if (isNameLike(firstPart)) {
                muhatapTanimi = firstPart
              } else {
                muhatapTanimi = ''
              }
            }
          }
          
          // Adres benzeri metinleri temizle
          if (muhatapTanimi && isAddressLike(muhatapTanimi)) {
            muhatapTanimi = ''
          }
          
          // ƒ∞sim benzeri deƒüilse temizle
          if (muhatapTanimi && !isNameLike(muhatapTanimi)) {
            muhatapTanimi = ''
          }
        }
        const adRaw = getValue(r, [
          'Ad', 'Adi', 'Adƒ±', 'ADI', 'AD', 'First Name', 'FirstName', 'first name', 'firstname',
          'ƒ∞sim', 'Isim', 'isim', 'NAME', 'Name', 'name'
        ])
        const soyadRaw = getValue(r, [
          'Soyad', 'Soyadƒ±', 'Soyadi', 'SOYAD', 'SOYADI', 'Last Name', 'LastName', 'last name', 'lastname',
          'Surname', 'surname', 'SURNAME'
        ])
        let ad = adRaw !== undefined && adRaw !== null ? String(adRaw).trim() : ''
        let soyad = soyadRaw !== undefined && soyadRaw !== null ? String(soyadRaw).trim() : ''
        
        // Ad ve soyad alanlarƒ±nƒ± doƒürula ve temizle
        if (ad && (!isNameLike(ad) || isAddressLike(ad))) {
          ad = ''
        }
        if (soyad && (!isNameLike(soyad) || isAddressLike(soyad))) {
          soyad = ''
        }
        
        if ((!muhatapTanimi || muhatapTanimi === '') && (ad || soyad)) {
          muhatapTanimi = [ad, soyad].filter(Boolean).join(' ').trim()
        }

        // Excel'de "Muhatap Tanƒ±mƒ±" s√ºtunu tekrar ge√ßiyor, bu ikinci olanƒ± ek olarak al
        let muhatapTanimiEk = getValue(r, [
          'Muhatap Tanƒ±mƒ±', // ƒ∞kinci "Muhatap Tanƒ±mƒ±" s√ºtunu varsa
          'Muhatap Tanƒ±mƒ± Ek', 
          'Muhatap Tanimi Ek', 
          'muhatap tanƒ±mƒ± ek', 
          'muhatap tanimi ek', 
          'muhatap_tanimi_ek'
        ])
        
        // Muhatap tanƒ±mƒ± ek alanƒ±nƒ± temizle ve doƒürula
        if (muhatapTanimiEk !== undefined && muhatapTanimiEk !== null) {
          muhatapTanimiEk = String(muhatapTanimiEk).trim()
          
          // "Bor√ßlu" kelimesini i√ßeren deƒüerleri temizle
          if (muhatapTanimiEk.toLowerCase().includes('bor√ßlu') || muhatapTanimiEk.toLowerCase().includes('borclu')) {
            muhatapTanimiEk = ''
          }
          
          // Adres benzeri metinleri temizle
          if (muhatapTanimiEk && isAddressLike(muhatapTanimiEk)) {
            muhatapTanimiEk = ''
          }
          
          // ƒ∞sim benzeri deƒüilse temizle
          if (muhatapTanimiEk && !isNameLike(muhatapTanimiEk)) {
            muhatapTanimiEk = ''
          }
        }

        // Diƒüer alanlarƒ± ger√ßek s√ºtun ba≈ülƒ±klarƒ±na g√∂re yakala
        // Excel tarih formatƒ±nƒ± string'e √ßevir
        const avukatAtamaTarihiRaw = getValue(r, ['Avukat Atama Tarihi', 'avukat atama tarihi'])
        const avukatAtamaTarihi = avukatAtamaTarihiRaw ? String(avukatAtamaTarihiRaw) : undefined
        const durum = getValue(r, ['Durum', 'durum'])
        const durumTanimi = getValue(r, ['Durum Tanƒ±mƒ±', 'durum tanƒ±mƒ±', 'Durum Tanimi'])
        const sozlesmeHesabi = getValue(r, ['S√∂zle≈üme hesabƒ±', 's√∂zle≈üme hesabƒ±', 'Sozlesme hesabi'])
        const tcKimlikNo = getValue(r, ['TC kimlik no', 'TC Kimlik No', 'tc kimlik no']) || ilgiliTCKN
        const vergiNo = getValue(r, ['Vergi No', 'vergi no', 'Vergi Numarasƒ±'])
        const icraDosyaNumarasi = getValue(r, ['ƒ∞cra Dosya Numarasƒ±', 'icra dosya numarasƒ±', 'ƒ∞cra Dosya No'])
        const icraDairesiTanimi = getValue(r, ['ƒ∞cra Dairesi Tanƒ±mƒ±', 'icra dairesi tanƒ±mƒ±'])
        const adresBilgileri = getValue(r, ['Adres Bilgileri', 'adres bilgileri', 'Adres'])
        const il = getValue(r, ['ƒ∞l', 'il', 'IL'])
        const ilce = getValue(r, ['ƒ∞l√ße', 'il√ße', 'ILCE'])
        const telefon = getValue(r, ['Telefon', 'telefon', 'Telefon No', 'Telefon_1', 'Telefon 1'])
        const telefon2 = getValue(r, ['Telefon_2', 'Telefon 2', 'Telefon2', 'ƒ∞kinci Telefon'])
        const telefon3 = getValue(r, ['Telefon_3', 'Telefon 3', 'Telefon3', '√ú√ß√ºnc√º Telefon'])
        const telefonAboneGrubu = getValue(r, ['Telefon Abone Grubu', 'telefon abone grubu', 'Abone Grubu'])
        const asilAlacak = parseTrNumber(getValue(r, ['Asƒ±l Alacak', 'asƒ±l alacak', 'Asil Alacak']))
        const takipCikisMiktari = parseTrNumber(getValue(r, ['Takip √áƒ±kƒ±≈ü Miktarƒ±', 'takip √ßƒ±kƒ±≈ü miktarƒ±']))
        const takipOncesiTahsilat = parseTrNumber(getValue(r, ['Takip √ñncesi Tahsilat', 'takip √∂ncesi tahsilat']))
        const takipSonrasiTahsilat = parseTrNumber(getValue(r, ['Takip Sonrasƒ± Tahsilat', 'takip sonrasƒ± tahsilat']))
        const toplamAcikTutar = parseTrNumber(getValue(r, ['Toplam A√ßƒ±k tutar', 'toplam a√ßƒ±k tutar']))
        const guncelBorc = parseTrNumber(getValue(r, ['G√ºncel Bor√ß', 'g√ºncel bor√ß', 'Guncel Borc']))
        const itirazDurumu = getValue(r, ['ƒ∞tiraz Durumu', 'itiraz durumu'])
        const borcluTipiTanimi = getValue(r, ['Bor√ßlu Tipi Tanƒ±mƒ±', 'bor√ßlu tipi tanƒ±mƒ±', 'Borclu Tipi']) || 'Ger√ßek Ki≈üi'
        const takipTarihiRaw = getValue(r, ['Takip Tarihi', 'takip tarihi'])
        const takipTarihi = takipTarihiRaw ? String(takipTarihiRaw) : undefined
        const hitamTarihiRaw = getValue(r, ['Hitam Tarihi', 'hitam tarihi'])
        const hitamTarihi = hitamTarihiRaw ? String(hitamTarihiRaw) : undefined
        const nedenTanimi = getValue(r, ['Neden Tanƒ±mƒ±', 'neden tanƒ±mƒ±'])
        const durumTuru = getValue(r, ['Durum T√ºr√º', 'durum t√ºr√º'])
        const durumTuruTanimi = getValue(r, ['Durum T√ºr√º Tanƒ±mƒ±', 'durum t√ºr√º tanƒ±mƒ±'])
        const tesisatDurumu = getValue(r, ['Tesisat Durumu', 'tesisat durumu'])
        const odemeDurumu = getValue(r, ['√ñdeme Durumu', '√∂deme durumu'])
        const vekaletUcreti = parseTrNumber(getValue(r, ['Vekalet √úcreti', 'vekalet √ºcreti']))
        const neden = getValue(r, ['Neden', 'neden'])
        const uyapDurumu = getValue(r, ['Uyap Durumu', 'uyap durumu'])
        const telefonTesisat = getValue(r, ['Telefon Tesisat', 'telefon tesisat'])
        const tesisatDurumuTanimi = getValue(r, ['Tesisat Durumu Tanƒ±mƒ±', 'tesisat durumu tanƒ±mƒ±'])

        // √ñnce zorunlu alanlarƒ± kontrol et
        const requiredFieldErrors = validateRequiredFields({ durumTanitici })
        if (requiredFieldErrors.length > 0) {
          requiredFieldErrors.forEach(error => {
            const processingError = logProcessingError(index, new Error(error), { durumTanitici }, 'REQUIRED_FIELD_CHECK')
            processingErrors.push(processingError)
            errors.push(`Satƒ±r ${index + 2}: ${error}`)
          })
          errorCount++
          continue
        }

        // Tanƒ±lama logu (ilk 5 satƒ±rƒ± logla)
        if (index < 5) {
          console.log(`[upload-excel][Row ${index + 2}]`)
          console.log(`  - Durum Tanƒ±tƒ±cƒ±: '${durumTanitici}'`)
          console.log(`  - Muhatap Tanƒ±mƒ±: '${muhatapTanimi ?? 'BO≈û'}'`)
          console.log(`  - Ad: '${ad}' | Soyad: '${soyad}'`)
          console.log(`  - ƒ∞lgili TCKN: '${ilgiliTCKN ?? 'BO≈û'}'`)
          console.log(`  - ƒ∞l: '${il ?? 'BO≈û'}' | Telefon: '${telefon ?? 'BO≈û'}'`)
          console.log(`  - G√ºncel Bor√ß: '${guncelBorc ?? 'BO≈û'}'`)
          console.log('  - T√ºm s√ºtunlar:', Object.keys(r).slice(0, 10).join(', '))
          console.log('---')
        }

        // Ad ve soyad varsa birle≈ütir
        const fullName = [ad, soyad].filter(Boolean).join(' ').trim()
        
        // Final muhatap tanƒ±mƒ± belirleme
        let finalMuhatapTanimi = null
        if (muhatapTanimi && String(muhatapTanimi).trim() !== '') {
          finalMuhatapTanimi = String(muhatapTanimi).trim()
        } else if (fullName !== '') {
          finalMuhatapTanimi = fullName
        }
        
        // Debug log
        if (index < 3) {
          console.log(`[Final] Muhatap Tanƒ±mƒ±: '${finalMuhatapTanimi ?? 'BO≈û KALACAK'}'`)
        }
        
        // Ham veriyi hazƒ±rla
        const rawData = {
          durumTanitici,
          ilgiliTCKN,
          avukatAtamaTarihi,
          durum,
          muhatapTanimi: finalMuhatapTanimi,
          durumTanimi,
          sozlesmeHesabi,
          tcKimlikNo,
          vergiNo,
          icraDosyaNumarasi,
          icraDairesiTanimi,
          adresBilgileri,
          il,
          ilce,
          telefon,
          telefon2,
          telefon3,
          telefonAboneGrubu,
          asilAlacak,
          takipCikisMiktari,
          takipOncesiTahsilat,
          takipSonrasiTahsilat,
          toplamAcikTutar,
          guncelBorc,
          itirazDurumu,
          borcluTipiTanimi,
          hitamTarihi,
          takipTarihi,
          nedenTanimi,
          durumTuru,
          durumTuruTanimi,
          tesisatDurumu,
          odemeDurumu,
          vekaletUcreti,
          neden,
          muhatapTanimiEk: (muhatapTanimiEk && String(muhatapTanimiEk).trim() !== '' && muhatapTanimiEk !== finalMuhatapTanimi) ? 
            muhatapTanimiEk : undefined,
          uyapDurumu,
          telefonTesisat,
          tesisatDurumuTanimi,
          ad,
          soyad
        }
        
        // Veriyi temizle ve sanitize et
        const sanitizedData = sanitizeRowData(rawData)
        
        // Alan b√ºt√ºnl√ºƒü√º kontrol√º ve uyarƒ±lar
        Object.entries(sanitizedData).forEach(([fieldName, value]) => {
          const fieldWarnings = validateFieldIntegrity(fieldName, value, sanitizedData)
          fieldWarnings.forEach(warning => {
            warning.rowIndex = index
            warnings.push(warning)
          })
        })
        
        // Veri tiplerini doƒürula ve d√∂n√º≈üt√ºr
        const validation = validateAndConvertTypes(sanitizedData)
        if (!validation.isValid) {
          validation.errors.forEach(error => {
            const processingError = logProcessingError(index, new Error(error), sanitizedData, 'TYPE_VALIDATION')
            processingErrors.push(processingError)
            errors.push(`Satƒ±r ${index + 2}: ${error}`)
          })
          errorCount++
          continue
        }
        
        const recordData = validation.convertedData!

        try {
          // Retry logic i√ßin
          let retryCount = 0
          const maxRetries = 3
          let lastError: any = null
          
          while (retryCount <= maxRetries) {
            try {
              if (mode === 'update') {
                // Upsert modu: Mevcut kayƒ±t varsa g√ºncelle, yoksa olu≈ütur
                const existingRecord = await prisma.borcluBilgileri.findUnique({
                  where: { durumTanitici: recordData.durumTanitici },
                  select: { id: true }
                })
                
                if (existingRecord) {
                  await prisma.borcluBilgileri.update({
                    where: { durumTanitici: recordData.durumTanitici },
                    data: recordData
                  })
                  updatedCount++
                } else {
                  await prisma.borcluBilgileri.create({
                    data: recordData
                  })
                  createdCount++
                }
              } else {
                // Replace modu: Her zaman yeni kayƒ±t olu≈ütur (eski davranƒ±≈ü)
                await prisma.borcluBilgileri.create({
                  data: recordData
                })
                createdCount++
              }
              
              // Ba≈üarƒ±lƒ± i≈ülem
              processedRecords.push(recordData.durumTanitici)
              break // Retry d√∂ng√ºs√ºnden √ßƒ±k
              
            } catch (retryError) {
              lastError = retryError
              retryCount++
              
              // Ge√ßici hata mƒ± kontrol et
              const errorMessage = retryError instanceof Error ? retryError.message : String(retryError)
              const isTransientError = errorMessage.includes('SQLITE_BUSY') || 
                                     errorMessage.includes('database is locked') ||
                                     errorMessage.includes('timeout')
              
              if (isTransientError && retryCount <= maxRetries) {
                console.warn(`[upload-excel] Ge√ßici hata, yeniden deneniyor (${retryCount}/${maxRetries}):`, errorMessage)
                await new Promise(resolve => setTimeout(resolve, 100 * retryCount)) // Exponential backoff
                continue
              } else {
                throw retryError // Retry limiti a≈üƒ±ldƒ± veya kalƒ±cƒ± hata
              }
            }
          }
          
        } catch (dbError) {
          // Database i≈ülem hatasƒ±
          const processingError = logProcessingError(index, dbError, recordData, 'DATABASE_OPERATION')
          processingErrors.push(processingError)
          
          // Kritik hata kontrol√º
          const errorMessage = dbError instanceof Error ? dbError.message : String(dbError)
          if (errorMessage.includes('UNIQUE constraint') || 
              errorMessage.includes('NOT NULL constraint') ||
              errorMessage.includes('FOREIGN KEY constraint')) {
            hasCriticalErrors = true
          }
          
          throw dbError // Ana catch bloƒüuna ge√ß
        }

        successCount++
      } catch (error) {
        errorCount++
        
        // G√ºvenli veri eri≈üimi i√ßin mevcut satƒ±r verilerini kullan
        const safeData = {
          rowIndex: index + 2,
          rawData: row
        }
        
        const processingError = logProcessingError(index, error, safeData, 'ROW_PROCESSING')
        processingErrors.push(processingError)
        
        const errorMessage = error instanceof Error ? error.message : 'Bilinmeyen hata'
        errors.push(`Satƒ±r ${index + 2}: ${errorMessage}`)
        
        // Kritik hata oranƒ± kontrol√º
        const errorRate = errorCount / (index + 1)
        if (errorRate > 0.5 && index > 10) {
          console.error(`[upload-excel] Y√ºksek hata oranƒ± tespit edildi: %${(errorRate * 100).toFixed(1)}`)
          hasCriticalErrors = true
          break // ƒ∞≈ülemi durdur
        }
      }
    }
    
    // Rollback kontrol√º
    if (hasCriticalErrors && shouldUseTransaction && processedRecords.length > 0) {
      console.warn(`[upload-excel] Kritik hatalar nedeniyle rollback yapƒ±lƒ±yor...`)
      
      try {
        // Manuel rollback - i≈ülenmi≈ü kayƒ±tlarƒ± geri al
        if (mode === 'replace') {
          // Replace modunda t√ºm yeni kayƒ±tlarƒ± sil
          const deleteResult = await prisma.borcluBilgileri.deleteMany({
            where: {
              durumTanitici: {
                in: processedRecords
              }
            }
          })
          console.log(`[upload-excel] Rollback: ${deleteResult.count} kayƒ±t silindi`)
        }
        
        return NextResponse.json({
          success: false,
          message: 'Kritik hatalar nedeniyle i≈ülem geri alƒ±ndƒ±',
          successCount: 0,
          errorCount,
          createdCount: 0,
          updatedCount: 0,
          mode,
          errors: errors.slice(0, 10),
          errorReport: generateErrorReport(processingErrors),
          rolledBack: true,
          rollbackReason: 'Y√ºksek hata oranƒ± veya kritik veritabanƒ± hatalarƒ±'
        }, { status: 400 })
        
      } catch (rollbackError) {
        console.error(`[upload-excel] Rollback hatasƒ±:`, rollbackError)
        return NextResponse.json({
          success: false,
          message: 'ƒ∞≈ülem ba≈üarƒ±sƒ±z ve rollback yapƒ±lamadƒ±',
          error: 'Kritik sistem hatasƒ±'
        }, { status: 500 })
      }
    }

    // Hata raporu olu≈ütur
    const errorReport = generateErrorReport(processingErrors)
    
    // Kullanƒ±cƒ± dostu mesaj olu≈ütur
    let userMessage = ''
    let suggestions: string[] = []
    
    if (errorCount === 0) {
      userMessage = mode === 'update' 
        ? `‚úÖ Excel dosyasƒ± ba≈üarƒ±yla i≈ülendi! ${createdCount} yeni kayƒ±t eklendi, ${updatedCount} kayƒ±t g√ºncellendi.`
        : `‚úÖ Excel dosyasƒ± ba≈üarƒ±yla i≈ülendi! ${createdCount} kayƒ±t eklendi.`
    } else if (successCount > 0) {
      userMessage = `‚ö†Ô∏è Excel dosyasƒ± kƒ±smen i≈ülendi. ${successCount} kayƒ±t ba≈üarƒ±lƒ±, ${errorCount} kayƒ±t ba≈üarƒ±sƒ±z.`
      suggestions.push('Hatalƒ± satƒ±rlarƒ± kontrol edin ve d√ºzelttikten sonra tekrar y√ºkleyin')
      
      if (warnings.length > 0) {
        suggestions.push('Veri kalitesini artƒ±rmak i√ßin uyarƒ±larƒ± g√∂zden ge√ßirin')
      }
    } else {
      userMessage = `‚ùå Excel dosyasƒ± i≈ülenemedi. T√ºm satƒ±rlarda hata var.`
      suggestions.push('Excel dosyanƒ±zƒ±n formatƒ±nƒ± kontrol edin')
      suggestions.push('Zorunlu alanlarƒ±n (Durum Tanƒ±tƒ±cƒ±) dolu olduƒüundan emin olun')
      suggestions.push('Sayƒ±sal alanlarƒ±n doƒüru formatta olduƒüunu kontrol edin')
    }
    
    // Performans metrikleri
    const processingEndTime = Date.now()
    const processingDuration = processingEndTime - Date.now() // Bu ger√ßek implementasyonda ba≈ülangƒ±√ß zamanƒ± tutulmalƒ±
    
    // Detaylƒ± √∂zet
    const detailedSummary = {
      totalRows: data.length,
      processedRows: successCount,
      failedRows: errorCount,
      successRate: data.length > 0 ? Math.round((successCount / data.length) * 100) : 0,
      hasErrors: errorCount > 0,
      hasWarnings: warnings.length > 0,
      warningCount: warnings.length,
      processingTime: `${Math.round(processingDuration / 1000)}s`,
      dataQuality: {
        emptyMuhatapCount: warnings.filter(w => w.message.includes('muhatap tanƒ±mƒ± bo≈ü')).length,
        invalidTCKNCount: warnings.filter(w => w.message.includes('TCKN') || w.message.includes('TC kimlik')).length,
        invalidPhoneCount: warnings.filter(w => w.message.includes('telefon')).length,
        negativeAmountCount: warnings.filter(w => w.message.includes('negatif')).length
      }
    }
    
    // √ñneriler olu≈ütur
    if (detailedSummary.dataQuality.emptyMuhatapCount > 0) {
      suggestions.push(`${detailedSummary.dataQuality.emptyMuhatapCount} kayƒ±tta muhatap tanƒ±mƒ± bo≈ü`)
    }
    if (detailedSummary.dataQuality.invalidTCKNCount > 0) {
      suggestions.push(`${detailedSummary.dataQuality.invalidTCKNCount} kayƒ±tta ge√ßersiz TC kimlik numarasƒ±`)
    }
    if (detailedSummary.dataQuality.invalidPhoneCount > 0) {
      suggestions.push(`${detailedSummary.dataQuality.invalidPhoneCount} kayƒ±tta ge√ßersiz telefon numarasƒ±`)
    }
    
    console.log(`[upload-excel] ƒ∞≈ülem tamamlandƒ±: ${successCount}/${data.length} ba≈üarƒ±lƒ±`)
    
    return NextResponse.json({
      success: errorCount === 0,
      message: userMessage,
      suggestions,
      successCount,
      errorCount,
      createdCount,
      updatedCount,
      mode,
      errors: errors.slice(0, 10),
      errorReport,
      processingErrors: processingErrors.slice(0, 5), // ƒ∞lk 5 detaylƒ± hata
      warnings: warnings.slice(0, 10), // ƒ∞lk 10 uyarƒ±
      summary: detailedSummary,
      // Kullanƒ±cƒ± i√ßin actionable feedback
      nextSteps: generateNextSteps(detailedSummary, processingErrors, warnings)
    })

  } catch (error) {
    console.error('Excel y√ºkleme hatasƒ±:', error)
    return NextResponse.json(
      { error: 'Excel dosyasƒ± i≈ülenirken hata olu≈ütu' },
      { status: 500 }
    )
  }
}